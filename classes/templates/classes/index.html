{% extends 'classes/layout.html' %}
{% load static %}

{% block content %}

<html>
<link rel="stylesheet" type="text/css" href="{% static 'classes/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/assets/css/bootstrap.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/assets/css/github.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/dist/bootstrap-clockpicker.css' %}">

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

  <script type="text/javascript" src="{% static 'classes/buildings.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/printers.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/laundry.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/hotspots.js' %}"></script>

  <script type="text/javascript" src="{% static 'classes/assets/js/jquery.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/assets/js/bootstrap.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/dist/bootstrap-clockpicker.js' %}"></script>

<head bgcolor="#000000">
  <title>ClassMaps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>

  <style>
      html, body {
       height: 100%;
      }
      #map {
          height: 100%;
          width: 100%;
          float: left;
          z-index: 1;
          position: relative;
      }
    .slidecontainer {
        margin: 0 auto;
        width: 350px;
    }
    .btn-remove {background-color: #f44336;} /* red */
    .overlay {
      height: auto;
      width: 100%;
      margin-left: -100%;
      position: relative;
      float: right;
      z-index: 2;
      padding-top: 1%;
      background-color:rgba(0,0,0,.5); // Sets to 50% transparent;
      pointer-events: auto;
    }
    .dropdown-menu{
      background-color:	#D3D3D3;
      width: 40px;
    }
    ::placeholder {
      color: #d3d3d3;
      opacity: 1; /* Firefox */
    }
    :-ms-input-placeholder { /* Internet Explorer 10-11 */
       color: #d3d3d3;
    }
    ::-ms-input-placeholder { /* Microsoft Edge */
       color: #d3d3d3;
    }
    input, select, textarea {
      color: white;
    }
    textarea:focus, input:focus {
        color: white;
    }
    .astext {
      background:none;
      border:none;
      color: orange;
    }
    .fa{
      padding-right: 5px;
      padding-left: 5px;
    }
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
    }

    .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        color: #818181;
        display: block;
        transition: 0.3s;
    }

    .sidenav a:hover {
        color: #f1f1f1;
    }

    .sidenav .closebtn {
        position: absolute;
        top: 0;
        right: 25px;
        font-size: 36px;
        margin-left: 50px;
    }
    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}
    }
    /* Start saved list css */
    .listOverlay {
      position: fixed;
      width: 300px;
      height: 50%;
      top: 1;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 3;
      cursor: pointer;
    }
    .listText {
      color: white;
    }
    .listTitle {
      color: white;
      font-size: large;
      text-align: left;
    }
    /* End saved list css */
  </style>
</head>

<body bgcolor="#000000">
  <div id="map"></div>

  <!--  sidebar div  -->
  <div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="#">About</a>
  <a href="#">Services</a>
  <a href="#">Clients</a>
  <a href="#">Contact</a>
</div>

  <div id="overlay" class="overlay">
    <form method="GET" action="{% url 'classes:search' %}">
     <a href="http://classmaps.herokuapp.com">
     <img src="{% static 'classes/images/lightlogo.png'%}" alt="ClassMaps" style="width:52px; float:left;" hspace="10">
     </a>
<!--     <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776;</span> -->
    <div style="width:20%; float:left; padding-right: 10px;">
        <input name = "q" value="{{request.GET.q}}" placeholder="Enter a course or building...">
    </div>

   <div style="float:left; padding-right: 10px;">
    <div class="dropdown" style="float:left;">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="fa fa-calendar"></i>
      </button>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <label class="switch">
          Monday
          <input name = "M" value = "M" type="checkbox">
          <span class="slider"></span>
        </label>
        <label class="switch">
          Tuesday
          <input name = "T" value = "T" type="checkbox">
          <span class="slider"></span>
        </label>
        <label class="switch">
          Wednesday
          <input name = "W" value = "W" type="checkbox">
          <span class="slider"></span>
        </label>
        <label class="switch">
          Thursday
          <input name = "Th" value = "Th" type="checkbox">
          <span class="slider"></span>
        </label>
        <label class="switch">
          Friday
          <input name = "F" value = "F" type="checkbox">
          <span class="slider"></span>
        </label>
        </div>
    </div>
    </div>

    <div style="width:120px; float:left; padding-right: 10px;">
      <div class="input-group clockpicker pull-center" data-placement="left" data-align="top" data-autoclose="false">
        <input type="text" class="form-control" name="t" placeholder="Set Time" style="color: white;" readonly>
        <span class="input-group-addon">
          <span class="glyphicon glyphicon-time"></span>
        </span>
      </div>
    </div>

    <div style="float:left;  padding-right: 10px;">
      <button class="btn btn-success" type="submit">
        <i class="fa fa-search"></i>Search ClassMaps
      </button>
    </div>
  </form>

    <div style="float: right; margin: auto;">
    <p style="color: #ffffff;">Welcome, {{netid}}</p>
    <button class="astext" id="Logout">
        Sign Out
    </button>
  </div>
 </div>
 <!-- overlay div ends -->
 <div id="listOverlay" class="listOverlay" style="overflow: auto;">
   <table id="myTable" class="table order-list">
   <thead>
       <tr>
           <td><div class="listTitle">Saved markers</div></td>
       </tr>
   </thead>
   <tfoot>
       <tr>
           <td colspan="5" style="text-align: left;">
               <input type="button" class="btn btn-lg btn-block " id="export" value="Export to Calendar" />
           </td>
       </tr>
       <tr>
       </tr>
   </tfoot>
</table>
</div>
<!--  script for saved list  -->
<script>
var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
console.log(width);
if(width < 700){
    var x = document.getElementById("listOverlay");
    x.style.display = "block";
}
function addRow(name, button) {
    var newRow = $("<tr>");
    var cols = "";

    cols += '<td><div class="listText" name="name">'+name+'</div></td>';
    cols += '<td>'+button+'</td>';
    newRow.append(cols);
    $("table.order-list").append(newRow);
}

$("table.order-list").on("click", ".ibtnDel", function (event) {
    $(this).closest("tr").remove();
});
</script>

<!--  script for sidebar  -->
 <script>
   document.getElementById("mySidenav").style.width = "250px";
function openNav() {
    document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
}
</script>
 <script type="text/javascript">
   $('.clockpicker').clockpicker({
     twelvehour: true,
     default: 'now'
   })
   .find('input').change(function(){
     console.log(this.value);
   });
   var input = $('#single-input').clockpicker({
     placement: 'bottom',
     align: 'left',
     autoclose: true,
     default: 'now'
   });
</script>

<script type="text/javascript">
document.getElementById("Logout").onclick = function () {
    location.href = "https://classmaps.herokuapp.com/accounts/logout";
};
</script>
  <script>
    // Adds different layer groups
    var printers = L.layerGroup();
    var hotspots = L.layerGroup();
    var laundry = L.layerGroup();
    var buildings = L.layerGroup();

     var printerIcon = L.icon({
       iconUrl: "{% static 'classes/images/printer.png' %}",
       iconSize:     [28, 28], // size of the icon
       iconAnchor:   [14, 14], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
     });
     var laundryIcon = L.icon({
       iconUrl: "{% static 'classes/images/washing-machine.png' %}",
       iconSize:     [28, 28], // size of the icon
       iconAnchor:   [14, 14], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
     });
     var hotspotIcon = L.icon({
       iconUrl: "{% static 'classes/images/hotspot.png' %}",
       iconSize:     [26, 26], // size of the icon
       iconAnchor:   [13, 13], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
     });
     var savedIcon = L.icon({
       iconUrl: "{% static 'classes/images/marker-icon-orange.png' %}",
       iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, -35] // point from which the popup should open relative to the iconAnchor
     });
     var myIcon = L.icon({
       iconUrl: "{% static 'classes/images/youarehere.png' %}",
       iconSize:     [35, 35], // size of the icon
       iconAnchor:   [18, 18], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, -18] // point from which the popup should open relative to the iconAnchor
     });
    for (var i = 0; i < printerLocs.length; i++) {
  //if (hi[i][3] == '6' || hi[i][3] == '29')
    if (printerLocs[i][3] == '6') L.marker([printerLocs[i][0], printerLocs[i][1]], {icon: printerIcon}).bindPopup(printerLocs[i][2]).addTo(printers);
    if (printerLocs[i][3] == '29') L.marker([printerLocs[i][0], printerLocs[i][1]], {icon: printerIcon}).bindPopup(printerLocs[i][2]).addTo(printers);
    if (printerLocs[i][3] == '28') L.marker([printerLocs[i][0], printerLocs[i][1]], {icon: printerIcon}).bindPopup(printerLocs[i][2]).addTo(printers);
 }
 for (var i = 0; i < laundryLocs.length; i++) {
  //if (hi[i][3] == '6' || hi[i][3] == '29')
    L.marker([laundryLocs[i][0], laundryLocs[i][1]], {title: laundryLocs[i][2], icon: laundryIcon}).bindPopup(laundryLocs[i][2]).addTo(laundry);
 }
 for (var i = 0; i < hotspotLocs.length; i++) {
  //if (hi[i][3] == '6' || hi[i][3] == '29')
    L.marker([hotspotLocs[i][0], hotspotLocs[i][1]], {title: hotspotLocs[i][2], icon: hotspotIcon}).bindPopup(hotspotLocs[i][2]).addTo(hotspots);
 }
    // URLS of maps for different layers (note: need to add attributes)
    var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
      '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery © <a href="http://mapbox.com">Mapbox</a>',
    mbUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    mbUrl2 = 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    // Different layers
    var regular   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
    satellite  = L.tileLayer(mbUrl2, {id: 'mapbox.satellite',   attribution: mbAttr});
    // Initializes the map
    var map = L.map('map', {
      center: [40.347, -74.653],
      zoom: 16,
      layers: [regular, buildings],
      zoomControl: true
    });
    /*$('.pure-button').on('click', function(){
mymap.locate({setView: true, maxZoom: 15});
});*/

    
    // Bookmarks
    //var control = new L.Control.Bookmarks().addTo(map);
    // Our different layers
    var baseLayers = {
      "Regular": regular,
      "Satellite": satellite
    };
    // Our overlays
    var overlays = {
      "Printers": printers,
      "Laundry": laundry,
      "Hotspots": hotspots,
      "Buildings": buildings
    };
    // Adds overlays and layers to map
    L.control.layers(baseLayers, overlays, {position: 'bottomright', collapsed: false}).addTo(map);
    map.zoomControl.setPosition('bottomright');

    
L.easyButton('<img src="https://image.flaticon.com/icons/svg/24/24211.svg" style="width:16px">', function (btn, map) {

    map.locate({
        setView: true,
        maxZoom: 18
    });

    //map.locate({setView: true,watch: true, maxZoom: 16});
    function onLocationFound(e) {
    var radius = e.accuracy / 2;
    L.marker(e.latlng, {icon: myIcon}).addTo(map)
        .bindPopup("You are within " + Math.round(radius) + " meters from this point").openPopup();
    L.circle(e.latlng, radius).addTo(map);
    }
    map.on('locationfound', onLocationFound);
}).setPosition('bottomright').addTo(map);

L.easyButton('<img src="https://png.icons8.com/metro/1600/home.png" style="width:16px">', function(btn, map){
    map.setView(new L.LatLng(40.347, -74.653), 16);
//map.setView(        [40.347, -74.653],      zoom: 16);
}).setPosition('bottomright').addTo(map);

L.easyButton('<img src="https://cdn1.iconfinder.com/data/icons/disable-sign/300/Blind-eye-dark-512.png" style="width:16px">', function(btn, map){
    var x = document.getElementById("listOverlay");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}).setPosition('bottomright').addTo(map);
    // Limits zoom (we could get rid of this)
    map.options.minZoom = 14;
    map.options.maxZoom = 18;
    function getColor(d) {
  if (d == 'dormitory') return '#800026';
  else if (d == 'university') return '#FEB42C';
  else return '#FED976';
  /*return d > 1000 ? '#800026' :
      d > 500  ? '#BD0026' :
      d > 200  ? '#E31A1C' :
      d > 100  ? '#FC4E2A' :
      d > 50   ? '#FD8D3C' :
      d > 20   ? '#FEB24C' :
      d > 10   ? '#FED976' :
            '#FFEDA0';*/
}
    function style(feature) {
  return {
    weight: 2,
    opacity: 1,
    color: 'white',
    dashArray: '3',
    fillOpacity: 0.7,
    fillColor: getColor(feature.properties.building)
    //fillColor: '#FED976'
  };
}
      function highlightFeature(e) {
  var layer = e.target;
  layer.setStyle({
    weight: 5,
    color: '#666',
    dashArray: '',
    fillOpacity: 0.7
  });
  //if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
  //  layer.bringToFront();
  //}
  //info.update(layer.feature.properties);
}
function onEachFeature(feature, layer) {
  var buildquery = feature.properties.name
  var buildingtext = buildquery +
         "<form method=\"GET\" action=\"{% url 'classes:search' %}\">" +"<br>"+
         "<button class=\"btn btn-success\" name=\"q\" value=\""+buildquery+"\" type=\"submit\">" +
             "Classes Here" +
         "</button>" +
     "</form>";
  layer.bindPopup(buildingtext);
  layer.on({
    mouseover: highlightFeature,//,
    mouseout: resetHighlight,
    click: zoomToFeature
  });
}
function zoomToFeature(e) {
  map.fitBounds(e.target.getBounds());
  e.bindPopup("You are within meters from this point");//.openPopup();
}
function resetHighlight(e) {
  geojson.resetStyle(e.target);
  //info.update();
}
    var geojson;
  geojson = L.geoJson(buildingData, {style: style, onEachFeature: onEachFeature}).addTo(buildings);
 /* var legend = L.control({position: 'bottomright'});
legend.onAdd = function (buildings) {
  var div = L.DomUtil.create('div', 'info legend'),
    grades = ['dormitory', 'university', 'other'],
    labels = [],
    from, to;
  for (var i = 0; i < grades.length; i++) {
    from = grades[i];
    //to = grades[i + 1];
    labels.push(
      '<i style="background:' + getColor(from) + '"></i> ' +
      from + (from ? '&ndash;' + from : '+'));
  }
  div.innerHTML = labels.join('<br>');
  return div;
};
<<<<<<< HEAD
//legend.addTo(buildings);
    // Displays current user location and accuracy
    /*function onLocationFound(e) {
      var radius = e.accuracy / 2;
      L.marker(e.latlng).addTo(map).bindPopup("You are within " + radius + " meters from this point").openPopup();
      L.circle(e.latlng, radius).addTo(map);
    }
    map.on('locationfound', onLocationFound);*/
//     // Displays coordinates upon mouse click
//     var popup = L.popup();
//     function onMapClick(e) {
//       popup
//         .setLatLng(e.latlng)
//         .setContent("You clicked the map at " + e.latlng.toString())
//         .openOn(map);
//     }
//     map.on('click', onMapClick);

//legend.addTo(buildings);
/*
function addRow() {
    var newRow = $("<tr>");
    var cols = "";

    cols += '<td><input type="text" class="form-control" name="name"/></td>';
    cols += '<td><input type="text" class="form-control" name="mail"/></td>';
    cols += '<td><input type="text" class="form-control" name="phone"/></td>';

    cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';
    newRow.append(cols);
    $("table.order-list").append(newRow);
}
*/

lonlats = {};
var offset = 0.0001;
{% if saved_buildings %}
   {% for s in saved_buildings %}
     var key = "{{s.lon}} {{s.lat}}"
     var button =
     "<form method=\"GET\" action=\"{% url 'classes:index' %}\">" +"<br>"+
         "<button class=\"btn btn-remove\" name=\"r\" value=\"{{s.pk}}b\" type=\"submit\">" +
             "Remove" +
         "</button>" +
     "</form>";
     var text = "<div>{{s}}</div>"+button;
     if (key in lonlats) {
       lonlats[key] += "<br>"+text;
     } else {
       lonlats[key] = text;
     }
     addRow("{{s.names.0}}", button);
  {% endfor %}
{% endif %}
{% if saved_courses %}
   {% for s in saved_courses %}
     var key = "{{s.building_lon}} {{s.building_lat}}";
     var button =
     "<form method=\"GET\" action=\"{% url 'classes:index' %}\">" +"<br>"+
         "<button class=\"btn btn-remove\" name=\"r\" value=\"{{s.pk}}c\" type=\"submit\">" +
             "Remove" +
         "</button>" +
     "</form>";
     var text = "<div>{{s}}</div>"+button;
     if (key in lonlats) {
       lonlats[key] += "<br>"+text;
     } else {
       lonlats[key] = text;
     }

     // Testing
     addRow("{{s}} {{s.building}} {{s.time}}", button);
    {% endfor %}
{% endif %}
if (!jQuery.isEmptyObject(lonlats)) {
  for (var key in lonlats) {
    var tokens = key.split(" ");
    var lon = parseFloat(tokens[0])-offset;
    var lat = tokens[1];
    L.marker([lat, lon], {icon: savedIcon}).addTo(map).bindPopup(lonlats[key]);
  }
}

    // Searched marker
    {% if building %}
        var lon = "{{building.lon}}";
        var lat = "{{building.lat}}";
        var id = "{{building.pk}}";
        var type = "b";
        var name = "{{building}}";
    {% elif c %}
        var lon = "{{c.building_lon}}";
        var lat = "{{c.building_lat}}";
        var id = "{{c.pk}}";
        var type = "c";
        // modified this line to add parameters
        var name = "{{c}} {{c.building}} {{c.room}} {{c.day}} {{c.starttime}}-{{c.endtime}}";
    {% endif %}
    {% if building or c %}
      var search = "<div>" + name + "</div>" +
      "<form method=\"GET\" action=\"{% url 'classes:index' %}\">" +"<br>"+
          "<button id=\"addrow\" class=\"btn btn-success\" name=\"s\" value=\""+id+type+"\" type=\"submit\">" +
              "Save" +
          "</button>" +
      "</form>";
       L.marker([lat, parseFloat(lon)+offset]).addTo(map).bindPopup(search).openPopup();
       map.setView([lat, parseFloat(lon)+offset],17);
    {% endif %}
  </script>

</body>
</html>

{% endblock %}
