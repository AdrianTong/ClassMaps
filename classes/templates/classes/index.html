{% extends 'classes/layout.html' %}
{% load static %}

{% block content %}

<html>
<link rel="stylesheet" type="text/css" href="{% static 'classes/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/assets/css/bootstrap.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/assets/css/github.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'classes/dist/bootstrap-clockpicker.css' %}">

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

  <script type="text/javascript" src="{% static 'classes/buildings.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/printers.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/laundry.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/hotspots.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/water.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/kitchens.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/dining.js' %}"></script>

  <script type="text/javascript" src="{% static 'classes/assets/js/jquery.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/assets/js/bootstrap.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'classes/dist/bootstrap-clockpicker.js' %}"></script>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js" type="text/javascript"></script>



<head bgcolor="#000000">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118677193-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118677193-1');
</script>

  <title>ClassMaps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>

  <style>
      html, body {
       height: 100%;
      }
      #map {
          height: 100%;
          width: 100%;
          float: left;

        : 1;
          position: relative;
          z-index: 0;
      }
    ::-webkit-scrollbar {
        display: none;
    }
    .slidecontainer {
        margin: 0 auto;
        width: 350px;
    }
    .btn-remove {
      background-color: #f44336; /* red */
      font-size: 12px;
      padding: 3px;
    }
    .btn-remove:hover{
      background: #9B0606;
      color: white;
    }
    .btn-success{
      font-size: 12px;
      padding: 3px;
    }
    .export {
      padding: 5px
    }
    .overlay {
      height: auto;
      width: 100%;
      height: 55px;
      margin-left: -100%;
      position: relative;
      float: right;
      z-index: 1;
      padding-top: 1%;
      padding-right: 40px;
      padding-left: 10px;
      background-color:rgba(0,0,0,0.6); // Sets to 50% transparent;
      pointer-events: auto;
    }
    .dropdown-menu{
      background-color:	#f9f9f9;
      padding-left: 10px;
      width: 80px;
    }
    /* Show the dropdown menu on hover */
    .dropdown:hover .dropdown-content {
        display: block;
        z-index: 7;
    }
    /* Change the background color of the dropdown button when the dropdown content is shown */
    .dropdown:hover .dropbtn {
        background-color: #C30909;
    }
    ::placeholder {
      color: #d3d3d3;
      font-size: 15px;
      opacity: 1; /* Firefox */
    }
    :-ms-input-placeholder { /* Internet Explorer 10-11 */
       font-size: 15px;
       color: #d3d3d3;
    }
    ::-ms-input-placeholder { /* Microsoft Edge */
       font-size: 15px;
       color: #d3d3d3;
    }
    input, select, textarea {
      color: white;
    }
    textarea:focus, input:focus {
        color: white;
    }
    .astext {
      background:none;
      border:none;
      color: orange;
    }
    .fa{
      padding-right: 5px;
      padding-left: 5px;
    }
    /* Start help overlay css */
    .helpOverlay {
      position: fixed;
      display: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 1;
      right: 0;
      bottom: 0;
      background-color: rgba(211,211,211,0.65);
      z-index: 10;
      cursor: pointer;
      transition: 0.5s;
      text-align: center;
      padding-top: 60px;
    }
    /* Start sidebar css */
    .sideOverlay {
      position: fixed;
      display: none;
      width: 0;
      height: 100%;
      top: 0;
      left: 1;
      right: 0;
      bottom: 0;
      background-color: #d3d3d3;
      background: linear-gradient(to top, rgba(211,211,211,0.85), rgba(211,211,211,1));
      z-index: 8;
      cursor: pointer;
      transition: 0.5s;
      padding-top: 60px;
    }
    .sideOverlay a {
      padding: 6px 6px 6px 30px;
      text-decoration: none;
      font-size: 15px;
      color: #282828;
      display: block;
      transition: 0.5s;
    }
    .sideOverlay a:hover {
        color: #f1f1f1;
    }
    .sideOverlay .closebtn {
        position: absolute;
        top: 0;
        right: 15px;
        font-size: 34px;
        margin-left: 50px;
    }
    /*  Hover over inputs  */
    .overlay input:hover{
      color: white;
    }
    /* Start saved list css */
    .listOverlay {
      margin: 10px;
      border-radius: 4px;
      position: fixed;
      display: none;
      width: 240px;
      height: 45%;
      top: 1;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.6);
      z-index: 1;
      cursor: pointer;
    }
    .btn-remove2{
      float: right;
      background-color: #f44336; /* red */
      font-size: 12px;
      padding: 3px;
    }
    .listText {
      color: white;
      font-size: 12px;
      text-align: left;
      background:none;
      border:none;
      margin:0;
      padding:0;
      outline: none;
    }
    .listText:focus {
      background: none;
    }
    .listText:hover {
      color: #D3D3D3;
    }
    .listTitle {
      color: white;
      font-size: 17;
      text-align: left;
    }
    /* End saved list css */
    .slider {
      padding-left: 20px;
    }
    .ui-autocomplete {
      width: auto;
      height: auto;
      max-height: 55%;
      max-width: 40%;
      overflow-y: auto;
      font-size: 11px;
      z-index: 8;
    }
    @media only screen and (max-width: 600px) {
      .ui-autocomplete {
        width: 67%;
        height: auto;
        max-height: 80%;
        max-width: 67%;
        overflow-y: auto;
        font-size: 11px;
        z-index: 8;
      }
      .helpimage{
        width: 300px;
      }
    }
    /* Search result overlay */
    .resultsContainer {
      padding-top: 45px;
    }
    .resultsOverlay {
      height: auto;
      width: 100%;
      margin-left: -100%;
      position: relative;
      float: left;
      z-index: 0;
      padding-top: 1%;
      padding-bottom: 0.5%;
      background-color: 0;
      pointer-events: auto;
    }
    /* Horizontal Scroll */
    .match-group > .row {
      float: left;
      overflow-x: visible;
      white-space: nowrap;
      padding-left: 10px;
      padding-right: 10px;
    }
    .match-group > .row > .card {
      display: inline-block;
      float: none;
    }
    .card {
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
      transition: 0.3s;
      width: 140px;
      border-radius: 5px;
      margin-right: 6px;
      padding-top:25px;
      padding-bottom:20px;
    }
    .container a{
      font-size: 12px;
    }
    .container p{
      font-size: 12px;
    }
    .card:hover {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    }
    .container {
        padding: 2px 8px;
    }
  </style>
</head>

<!-- Autocomplete js -->
<script>
//   function selectClass(){
//   window.location.href = 'https://classmaps.herokuapp.com/courses/{{c.pk}}';
// }
// function selectBuilding(){
//   window.location.href = 'https://classmaps.herokuapp.com/buildings/{{b}}';
// }

$(function() {
  $("#search").autocomplete({
    minLength: 3,
    source: function(request, response) {
      $.ajax({
        url: "/api/query/",
        dataType: "json",
        data: {
          q: request.term,
          t: $('#clock').val(),
          M: convertBool($('#M').is(":checked")),
          T: convertBool($('#T').is(":checked")),
          W: convertBool($('#W').is(":checked")),
          Th: convertBool($('#Th').is(":checked")),
          F: convertBool($('#F').is(":checked")),
        },
        success: function(data) {
          response(data)
        }
      });
    },
    select: function(event, ui) {
      if (ui.item) {
        $(event.target).val(ui.item.value);
      }
      window.location.href = "{% url 'classes:index' %}"+ui.item.type+"/"+ui.item.id
    }
  });
});

// Convert to match main query format
function convertBool(b) {
  if (b) {
    return b;
  }
  return null;
}
</script>

  <div id="map"></div>

<!-- Overlay div begins -->
  <div id="overlay" class="overlay">
    <form id="searchbar" name="myform" method="GET" action="{% url 'classes:search' %}">
     <a href="https://classmaps.herokuapp.com">
     <img src="{% static 'classes/images/lightlogo.png'%}" alt="ClassMaps" style="width:42px; float:left; margin-right:10px">
     </a>

    <div style="width:30%; float:left;">
        <input id = "search" style="font-size:15px;" name = "q" value="{{request.GET.q}}" placeholder="Enter a course or building...">
    </div>
<!--     <div style="width:10px; float:left;">
      <input style="color: white;" placeholder="" readonly>
   </div> -->
    <div style="width:60px; float:left;">
      <div class="input-group clockpicker pull-center" data-placement="bottom" data-align="top" data-autoclose="false">
        <input id="clock" type="text" class="form-control" name="t" placeholder="  Time" style="font-size: 15px; color: white; cursor: pointer;" onfocus="this.blur()" readonly>
      </div>
    </div>
   <div style="width:5px; float:left;">
    <input type="text" style="color: white; cursor: pointer; font-size:15px;" placeholder="|" readonly>
   </div>
   <div style="float:left; width:55px;">
    <div class="dropdown" style="float:left;">
<!--       <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <img src="{% static 'classes/images/weekicon.png'%}" alt="Day of Week" style="width:20px;">
      </button> -->
      <input id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" type="text" class="form-control" placeholder="   Date" style="font-size: 15px; color: white; cursor: pointer;" readonly>
    <div id="dropdown-menu" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <label class="switch">
          <input id = "M" name = "M" value = "M" type="checkbox" onclick="dateCheck()">
          <span class="slider"> &nbspMonday </span>
        </label><br>
        <label class="switch">
          <input id = "T" name = "T" value = "T" type="checkbox" onclick="dateCheck()">
          <span class="slider"> &nbspTuesday </span>
        </label><br>
        <label class="switch">
          <input id = "W" name = "W" value = "W" type="checkbox" onclick="dateCheck()">
          <span class="slider"> &nbspWednesday </span>
        </label><br>
        <label class="switch">
          <input id = "Th" name = "Th" value = "Th" type="checkbox" onclick="dateCheck()">
          <span class="slider"> &nbspThursday </span>
        </label><br>
        <label class="switch">
          <input id = "F" name = "F" value = "F" type="checkbox" onclick="dateCheck()">
          <span class="slider"> &nbspFriday </span>
        </label>
        </div>
      </div>
    </div>

   <div style="width:20px; float:left;" onclick="clearForm();dateCheck();">
      <input type="text" style="color: white; cursor: pointer; font-size:20px;" placeholder="&times;" readonly>
   </div>
<!--
    <div style="float:left;">
      <input type="submit" style="display:none">
      </input>
    </div> -->
  </form>

  <div style="float: right; padding-right: 10px; position: fixed; top: 10px; right: 0;">
    <span style="font-size:25px;cursor:pointer; color: white; padding-bottom: 7px;" onclick="openNav()">&#9776;</span>
      </div>
  </div>

 <!-- overlay div ends -->

 <div id="listOverlay" class="listOverlay" style="overflow: auto;">
   <table id="myTable" class="table order-list">
   <thead>
       <tr>
           <td>
             <div class="listTitle" style="float: left;"><i class="fa fa-star"></i>Favorites</div>
         </td>
         <div style="float: right; padding-right: 3px;">
           <a href="javascript:void(0)" style="color: white" class="closebtn" onclick="closeFavorites()">&times;</a>
         </div>
       </tr>
   </thead>
   <!--
   <tfoot>
       <tr>
           <td colspan="5" style="text-align: left;">
               <input type="button" class="btn btn-lg btn-block" id="export" value="Export to Calendar" />
           </td>
       </tr>
   </tfoot>
-->
</table>
</div>

<!--  Code search result overlay -->
<div id="resultsContainer" class="resultsContainer" style="display: none;">
  <div id="resultsOverlay" class="resultsOverlay" style="overflow: auto;">
    <div class="container match-group" style="margin: 0;">
      <div id="buildings" class="row text-center" style="margin: 0;">
      </div>
    </div>
<!--
    <div class="container match-group">
      <div id="courses" class="row text-center">
      </div> -->
    </div>
  </div>
</div>

<!-- Script for matches -->
<script>
//check if checkboxes checked
function dateCheck(){
  var m = document.getElementById("M").checked;
  var t = document.getElementById("T").checked;
  var w = document.getElementById("W").checked;
  var th = document.getElementById("Th").checked;
  var f = document.getElementById("F").checked;
  if(m || t || w || th || f){
    var output= "";
    if(m) output += "m";
    if(t) output += "t";
    if(w) output += "w";
    if(th) output += "th";
    if(f) output += "f";
    console.log(output);
    document.getElementById("dropdownMenuButton").value=output;
    //document.getElementById("dropdownMenuButton").width = ((output.length + 1) * 8) + 'px';
  }
  else{
    document.getElementById("dropdownMenuButton").value=null;
    //document.getElementById("dropdownMenuButton").width="50px";
  }
}

function truncate(line, maxLength) {
  if (line.length <= maxLength) {
    return line;
  }
  return $.trim(line.substring(0, maxLength))+"...";
}

function addCourseRow(id, text) {
  $("#"+id).append("<div class=\"card\" onclick=\"selectClass()\">"+"<div class=\"container\">"+
    "<p>"+text+"</p>"+"</div>"+"</div>");
}
function addBuildingRow(id, text) {
  $("#"+id).append("<div \" style=\"padding-top: auto; padding-bottom: auto;\"class=\"card\" onclick=\"selectBuilding()\">"+"<div class=\"container\">"+
    "<p>"+text+"</p>"+"</div>"+"</div>");
}
function addResultRow(id, text) {
  $("#"+id).append("<div \" style=\"padding-top: 7px; padding-bottom: 20px;\"class=\"card\" onclick=\"selectBuilding()\">"+"<div class=\"container\">"+
    "<p>"+text+"</p>"+"</div>"+"</div>");
}
function addImageRow(id, text) {
  $("#"+id).append("<div \" style=\"padding-top: 5px; width: 390px; padding-bottom: 0;\"class=\"card\" onclick=\"selectBuilding()\">"+"<div class=\"container\">"+
    "<p>"+text+"</p>"+"</div>"+"</div>");
}
var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
console.log(width);
{% if num_matches < 9 %}
  if(width > 720){
    document.getElementById("resultsOverlay").style.width = "auto";
  }
  else{
    {% if num_matches < 3 %}
      document.getElementById("resultsOverlay").style.width = "auto";
    {% endif %}
  }
{% endif %}
{% if buildings or classes %}
  var matchesBlock = document.getElementById("resultsContainer");
  matchesBlock.style.display = "block";
  addResultRow("buildings", "{{num_matches}} matches for:<br>\""+truncate("{{q}}",19)+"\"<br>{{d}} {{t}}<br><a href=\"javascript:void(0)\" class=\"closebtn\" onclick=\"closeResults()\">&times;&nbspCLOSE</a>");
{% elif num_matches == 0 %}
//   if(document.getElementById("search").value != null){
//   }
  console.log("no results");
  var matchesBlock = document.getElementById("resultsContainer");
  matchesBlock.style.display = "block";
  addResultRow("buildings", "No matches for:<br>\""+truncate("{{q}}",19)+"\"<br>{{d}} {{t}}<br><a href=\"javascript:void(0)\" class=\"closebtn\" onclick=\"closeResults()\">&times;&nbspCLOSE</a>");
  if(width > 720){
  addImageRow("buildings", "<img src=\"{% static 'classes/images/calvinandhobbes.png'%}\" alt=\"NotFound\" class=\"center\" style=\"width:100%;\">");
  }
{% endif %}

{% if buildings %}
    {% for b in buildings %}
      alias = "{{b.names}}".split("/")[1];
      if (alias) {
        var formatted = "Building:<br>"+truncate("{{b}}", 20)+"<br>("+truncate(alias.substring(2,alias.length-1),15)+")";
        addBuildingRow("buildings", "<a href=\"/building/{{b.pk}}\" style=\"color: black;\">"+formatted);
      } else {
        var formatted = "Building:<br>"+truncate("{{b}}", 20);
        addBuildingRow("buildings", "<br><a href=\"/building/{{b.pk}}\" style=\"color: black;\">"+formatted);
      }
    {% endfor %}
{% endif %}

{% if classes %}
    {% for c in classes %}
      var formatted = "{{c}}".split("/")[0]+" {{c.section}}<br>{{c.day}} {{c.time}} <br>"+truncate("{{c.title}}", 19);
      addCourseRow("buildings", "<a href=\"/course/{{c.pk}}\" style=\"color: black;\">"+formatted);
    {% endfor %}
{% endif %}
</script>

<!--  Code for sidebar overlay  -->
   <div id="sideOverlay" class="sideOverlay" style="overflow: auto;">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a style="pointer-events: none;"> Welcome, {{netid}}</a>
    <a href="https://classmaps.herokuapp.com/about" target="_blank"><i class="fa fa-info-circle"></i> &nbsp&nbspAbout</a>
    <a onclick="openHelp()"><i class="fa fa-question-circle"></i> &nbsp&nbspHelp</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfOX9jOp3gI_k9EWZPRFgFlG76HYGUtcY1nLl1pCTybvus0nQ/viewform?usp=sf_link" target="_blank"><i class="fa fa-comment"></i> &nbspFeedback</a>
    <a href="https://classmaps.herokuapp.com/about/#team" target="_blank"><i class="fa fa-address-card"></i> &nbspContact</a>
    <a href="https://classmaps.herokuapp.com/accounts/logout"><i class="fa fa-sign-out"></i> &nbsp&nbspSign Out</a>

      <footer style="font-size: 12px; padding: 10px; position: absolute; bottom: 0; right: 0;">
        <p>To add the site to your phone's homescreen, open the <a style="padding: 0; font-size: 12px; color: #00aaee;" href="/">homepage</a></p>
        <p>On iPhone, click the <img height="24" src="{% static 'classes/images/action.png' %}"> button on the bottom of Safari</p>
        <p>On Android, click on the <img src="{% static 'classes/images/3dot.png' %}"/> button on the top right of Chrome</p>
        <p>Click "Add to Home Screen" <img src="{% static 'classes/images/icons/24x24.png' %}"/> ClassMaps</p>
      </footer>
  </div>

<!--  Code for help overlay  -->
   <div id="helpOverlay" class="helpOverlay" style="overflow: auto;" onclick="closeHelp()">
     <h3>Help</h3>
<!--      <a href="javascript:void(0)" class="closebtn" onclick="closeHelp()">&times;CLOSE</a>
     This is the help overlay. (This part has yet to be completed, sorry.) -->
     <img id="helpimage" src="{% static 'classes/images/helpoverlay.png'%}" style="width:490px;">
   </div>
<!-- sidenav script  -->
<script>

// Submit form when user presses 'enter'
$("#search").keypress(function(event) {
    if (event.which == 13) {
        event.preventDefault();
        $("#searchbar").submit();
    }
});

  /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
  function clearForm() {
    console.log("cleared form");
    document.getElementById("searchbar").reset();
    document.getElementById("search").value=null;
    updateColor(geojson);
  }
  function closeFavorites() {
      document.getElementById("listOverlay").style.display = "none";
  }
  function openHelp() {
      document.getElementById("helpOverlay").style.display = "block";
     document.getElementById("sideOverlay").style.width = "0";
      document.getElementById("sideOverlay").style.display = "none";
  }
  function closeHelp() {
      document.getElementById("helpOverlay").style.display = "none";
  }
  function closeResults() {
      document.getElementById("resultsOverlay").style.display = "none";
  }
  function openNav() {
      document.getElementById("sideOverlay").style.display = "block";
      document.getElementById("sideOverlay").style.width = "190px";
  }
  function closeNav() {
      document.getElementById("sideOverlay").style.width = "0";
      document.getElementById("sideOverlay").style.display = "none";
  }

  //  script for saved list
  var collapse = true;
  var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
  console.log(width);
  if(width > 720){
   var x = document.getElementById("listOverlay");
   x.style.display = "block";
    collapse = false;
  }
  else{
//     document.getElementById("ui-autocomplete").style.maxWidth="60%";
//     document.getElementById("ui-autocomplete").style.maxHeight="70%";
     console.log("mobile styling");
  }

  $('.dropdown-menu').on('click', function(e) {
    e.stopPropagation();
  });

$('.clockpicker').clockpicker({
     twelvehour: true,
     default: 'now'
   })
   .find('input').change(function(){
     console.log(this.value);
   });
   var input = $('#single-input').clockpicker({
     placement: 'bottom',
     align: 'left',
     autoclose: true,
     default: 'now'
   });

    // Adds different layer groups
    var printers = L.layerGroup();
    var hotspots = L.layerGroup();
    var waterspots = L.layerGroup();
    var laundry = L.layerGroup();
    var buildings = L.layerGroup();
    var kitchenspots = L.layerGroup();
    var diningspots = L.layerGroup();

    // Create custom icons for resource overlays
     var printerIcon = L.icon({
       iconUrl: "{% static 'classes/images/printer.png' %}",
       iconSize:     [28, 28], // size of the icon
       iconAnchor:   [14, 14], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
     });
     var laundryIcon = L.icon({
       iconUrl: "{% static 'classes/images/washing-machine.png' %}",
       iconSize:     [28, 28], 
       iconAnchor:   [14, 14], 
       popupAnchor:  [0, 0] 
     });
     var hotspotIcon = L.icon({
       iconUrl: "{% static 'classes/images/hotspot.png' %}",
       iconSize:     [26, 26], 
       iconAnchor:   [13, 13], 
       popupAnchor:  [0, 0] 
     });
     var waterIcon = L.icon({
       iconUrl: "{% static 'classes/images/watericon.png' %}",
       iconSize:     [28, 28], 
       iconAnchor:   [14, 14], 
       popupAnchor:  [0, 0] 
     });
     var kitchenIcon = L.icon({
       iconUrl: "{% static 'classes/images/kitch.png' %}",
       iconSize:     [28, 28], 
       iconAnchor:   [14, 14], 
       popupAnchor:  [0, 0] 
     });
    var diningIcon = L.icon({
       iconUrl: "{% static 'classes/images/dining.png' %}",
       iconSize:     [28, 28], 
       iconAnchor:   [14, 14], 
       popupAnchor:  [0, 0] 
     });
    var saladIcon = L.icon({
       iconUrl: "{% static 'classes/images/caesar.png' %}",
       iconSize:     [28, 28], 
       iconAnchor:   [14, 14], 
       popupAnchor:  [0, 0] 
     });
     var savedIcon = L.icon({
       iconUrl: "{% static 'classes/images/marker-icon-green.png' %}",
       iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, -35] // point from which the popup should open relative to the iconAnchor
     });
     var myIcon = L.icon({
       iconUrl: "{% static 'classes/images/youarehere.png' %}",
       iconSize:     [35, 35], // size of the icon
       iconAnchor:   [18, 18], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, -18] // point from which the popup should open relative to the iconAnchor
     });

// Put the locations for each resource to its corresponding layer
  for (var i = 0; i < printerLocs.length; i++) {
    L.marker([printerLocs[i][0], printerLocs[i][1]], {title: printerLocs[i][2], icon: printerIcon}).bindPopup(printerLocs[i][2]).addTo(printers);
 }
 for (var i = 0; i < laundryLocs.length; i++) {
    L.marker([laundryLocs[i][0], laundryLocs[i][1]], {title: laundryLocs[i][2], icon: laundryIcon}).bindPopup(laundryLocs[i][2]).addTo(laundry);
 }
 for (var i = 0; i < hotspotLocs.length; i++) {
    L.marker([hotspotLocs[i][0], hotspotLocs[i][1]], {title: hotspotLocs[i][2], icon: hotspotIcon}).bindPopup(hotspotLocs[i][2]).addTo(hotspots);
 }
 for (var i = 0; i < waterLocs.length; i++) {
    L.marker([waterLocs[i][0], waterLocs[i][1]], {title: waterLocs[i][2], icon: waterIcon}).bindPopup(waterLocs[i][2]).addTo(waterspots);
 }
 for (var i = 0; i < kitchens.length; i++) {
    L.marker([kitchens[i][0], kitchens[i][1]], {title: kitchens[i][2], icon: kitchenIcon}).bindPopup(kitchens[i][2]).addTo(kitchenspots);
 }
  for (var i = 0; i < dining.length; i++) {
    L.marker([dining[i][0], dining[i][1]], {title: dining[i][2], icon: diningIcon}).bindPopup(dining[i][2]).addTo(diningspots);
 }

    // URLs of different map layers and their attributions
    var mbAttr = 'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, ' +
      '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery © <a href="https://mapbox.com">Mapbox</a>',
    mbUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    mbUrl2 = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';

    // Different map layers
    var regular   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
    satellite  = L.tileLayer(mbUrl2, {id: 'mapbox.satellite', attribution: mbAttr});

    // Initializes the map with default layers
    var map = L.map('map', {
      center: [40.346825, -74.656595],
      zoom: 16,
      layers: [regular, buildings],
      zoomControl: true
    });

// Provides bounds and limits the user to only within those coordinates
var southWest = L.latLng(40.323212, -74.718103),
northEast = L.latLng(40.368481, -74.596444);
var bounds = L.latLngBounds(southWest, northEast);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

// Gives Jerry the Julius Caesar Salad Building
var temp = "{{netid}}";
if(temp === "jywei"){
L.marker([40.349152, -74.655383], {icon: saladIcon}).addTo(map)
    .bindPopup("Julius Caesar Salad Building - Jerry");
}

var searchLayer = L.layerGroup().addTo(map);
var saveLayer = L.layerGroup().addTo(map);

    // Our different layers
    var baseLayers = {
      "&nbspRegular": regular,
      "&nbspSatellite": satellite
    };
    // Our overlays
    var overlays = {
      "&nbspPrinters": printers,
      "&nbspLaundry": laundry,
      "&nbspHotspots": hotspots,
      "&nbspWater": waterspots,
      "&nbspKitchens": kitchenspots,
      "&nbspDining": diningspots,
      "&nbspHeatmap": buildings
    };
    // Adds overlays and layers to map
    L.control.layers(baseLayers, overlays, {position: 'bottomright', collapsed: collapse}).addTo(map);
    map.zoomControl.setPosition('bottomright');

// Button to locate current location
L.easyButton('<img src="{% static 'classes/images/currentloc.png' %}" style="width:16px">', function (btn, map) {
    map.locate({setView: true, maxZoom: 18});
    function onLocationFound(e) {
    var radius = e.accuracy / 2;
    L.marker(e.latlng, {icon: myIcon}).addTo(map)
        .bindPopup("You are within " + Math.round(radius) + " meters from this point").openPopup();
    L.circle(e.latlng, radius).addTo(map);
    }
    map.on('locationfound', onLocationFound);
}, 'Current location').setPosition('bottomright').addTo(map);

// Button to reset map to default view
L.easyButton('<img src="{% static 'classes/images/refresh.png' %}" style="width:16px">', function(btn, map) {
    map.setView(new L.LatLng(40.346825, -74.656595), 16);
}, 'Reset map').setPosition('bottomright').addTo(map);

// Button to toggle favorites bar on/off
L.easyButton('<img src="{% static 'classes/images/star.png' %}" style="width:16px">', function(btn, map) {
    var x = document.getElementById("listOverlay");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}, 'Toggle favorites').setPosition('bottomright').addTo(map);

    // Limits zoom (we could get rid of this)
  map.options.minZoom = 14;
  map.options.maxZoom = 18;

  function style(feature) {
    return {
      weight: 2,
      opacity: 1,
      color: 'white',
      dashArray: '3',
      fillOpacity: 0.7,
    };
  }
  function highlightFeature(e) {
    var layer = e.target;
    if (layer.getPopup().isOpen()) {
      layer.closeToolTip();
    }
    layer.setStyle({
      weight: 5,
      color: '#666',
      dashArray: '',
    });
}
function onEachFeature(feature, layer) {
  layer.bindPopup();
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: zoomToFeature
  });
}
function zoomToFeature(e) {
  map.fitBounds(e.target.getBounds());
  if (layer.getToolTip().isOpen()) {
    layer.closeToolTip();
  }
}
function resetHighlight(e) {
  var layer = e.target;
  layer.setStyle({
    weight: 1,
    color: 'white',
    dashArray: '3',
  });
}
    var geojson;
  geojson = L.geoJson(buildingData, {style: style, onEachFeature: onEachFeature}).addTo(buildings);

  // Add key if new or add value if key present
  function addDict(dict, key, val) {
    if (key in dict) {
      dict[key] += val;
    } else {
      dict[key] = val;
    }
  }

  function updateColor(geojson) {
    function getData() {
      return $.ajax({
        url: "/api/enroll/",
        dataType: "json",
        data: {
          t: $('#clock').val(),
          M: convertBool($('#M').is(":checked")),
          T: convertBool($('#T').is(":checked")),
          W: convertBool($('#W').is(":checked")),
          Th: convertBool($('#Th').is(":checked")),
          F: convertBool($('#F').is(":checked")),
        },
        success: function(data) {
          return data;
        }
      });
    }

    getData().success(function (data) {
      // Parse response
      students = {}
      courses = {}
      $.each(data, function(building, v) {
        $.each(v, function(type, num) {
            if (type === "students") {
              addDict(students, building, num);
            } else {
              addDict(courses, building, num);
            }
        });
      });

      // Update layers
      geojson.eachLayer(function(layer) {
        var name = layer.feature.properties.name
        var tokens = name.split(", ");
        var totalEnroll = 0;
        var totalCourse = 0;
        for (i = 0; i < tokens.length; i++) {
          if (tokens[i] in students) {
            totalEnroll += students[tokens[i]];
            totalCourse += courses[tokens[i]]
          }
        }
        var color = totalEnroll > 5000 ? '#800026' :
          totalEnroll > 2500  ? '#BD0026' :
          totalEnroll > 1000  ? '#E31A1C' :
          totalEnroll > 500  ? '#FC4E2A' :
          totalEnroll > 100   ? '#FD8D3C' :
          totalEnroll > 50   ? '#FEB24C' :
          totalEnroll > 0   ? '#FED976' :
                '#FFF';

        if (totalEnroll == 0 && layer.feature.properties.building === "dormitory") {
          layer.setStyle({
            fillColor: "#ADD8E6",
          });
          layer.bindTooltip(name);
          layer.bindPopup(name);
        } else {
          layer.setStyle({
            fillColor: color,
          });
          layer.bindTooltip(name+"<br>Students here: "+totalEnroll+"<br>Courses here: "+
                            totalCourse+"<br>");
          var buttontext =
             '<button class="btn btn-success" id="build" value="'+name+'" onclick="searchBuilding(\''+name+'\')"><i class="fa fa-search"></i>Classes Here</button>'

          layer.bindPopup(name+"<br>Students here: "+totalEnroll+"<br>Courses here: "+totalCourse+"<br>"+buttontext);
        }
      });
    });
  }

  // Set on page load
  updateColor(geojson);

  // Search when a building is clicked on
  function searchBuilding(name) {
    $("#search").val(name);
    $("#searchbar").submit();
  }

  // Reset whenever a time/day field is updated
  $("#clock").change(function() {
    updateColor(geojson);
  });

  $("#M").change(function() {
    updateColor(geojson);
  });

  $("#T").change(function() {
    updateColor(geojson);
  });

  $("#W").change(function() {
    updateColor(geojson);
  });

  $("#Th").change(function() {
    updateColor(geojson);
  });

  $("#F").change(function() {
    updateColor(geojson);
  });

  function removeButton(id, type) {
    return "<button id=\"remove\" class=\"btn btn-remove\" name=\"r\" type=\"submit\"onclick=\"remove(\'"+id+type+"\')\">" +
        "<i class=\"fa fa-close\">"+"</i>"+"Remove" +
    "</button>"
  }

  function addRow(name, lon, lat, id, button) {
      var newRow = $('<tr id="'+id+'">');
      var cols = "";

      cols += '<td><button class="listText" onclick="goToCoords('+lon+','+lat+')">'+name+'</button></td>';
      cols += '<td>'+button+'</td>';

      newRow.append(cols);
      $("table.order-list").append(newRow);
  }

  function goToCoords(lon, lat) {
    map.eachLayer(function (layer) {
      if (layer.dragging) {
        coords = layer.getLatLng()
        if (coords.lat === parseFloat(lat) && coords.lng === parseFloat(lon)-offset) {
          layer.openPopup()
          map.setView(new L.LatLng(lat, lon), 20);
        }
      }
    });
  }

  function save(id) {
    $.ajax({
       type: "POST",
       url: "{% url 'classes:save' %}",
       dataType: 'json',
       data: {
         s: id,
         csrfmiddlewaretoken: '{{ csrf_token }}'
       },
       success: function (data) {
         $("#myTable").find("tr:gt(0)").remove();
         searchLayer.clearLayers();
         updateSaved()
       }
    });
  }

  function remove(id) {
    $.ajax({
       type: "POST",
       url: "{% url 'classes:remove' %}",
       dataType: 'json',
       data: {
         r: id,
         csrfmiddlewaretoken: '{{ csrf_token }}'
       },
       success: function (data) {
         $("#myTable").find("tr:gt(0)").remove();
         updateSaved()
       }
    });
  }

  function updateSaved() {
    $.ajax({
      url: '/api/saved/',
      dataType: 'json',
      success: function (data) {
        saveLayer.clearLayers();
        lonlats = {};
        $.each(data, function(i, val) {
          $.each(val, function() {
            if (i === "buildings") {
              addRow(this['name'], this['lon'], this['lat'], this['id']+"b", removeButton(this['id'], "b"));
              var text = "<div>"+this['name']+"</div>"+removeButton(this['id'], "b");
            } else if (i === "courses") {
              var text = "<div>"+this['listing']+"</div><div>"+this['building_name']+" "+this['room']+"</div><div>"+this['time']+"</div>";
              addRow(text, this['lon'], this['lat'], this['id']+"c", removeButton(this['id'], "c"));
              text += "<br>"+removeButton(this['id'], "c");
            }
            var key = this['lon']+" "+this['lat'];
            if (key in lonlats) {
              lonlats[key] += "<hr style=\"border-color: black;\">"+text;
            } else {
              lonlats[key] = text;
            }
          });
        });
        if (!jQuery.isEmptyObject(lonlats)) {
          var count = 0;
          for (var key in lonlats) {
            var tokens = key.split(" ");
            var lon = parseFloat(tokens[0])-offset;
            var lat = tokens[1];
            if (lon) {
                L.marker([lat, lon], {icon: savedIcon}).addTo(saveLayer)
                 .bindPopup("<div style=\"max-height: 175px; overflow: scroll;\">"+lonlats[key]+"</div>");
            }
          }
        }
      }
    });
  }

  updateSaved()

lonlats = {};
var offset = 0.0001;

    // Searched marker
    {% if building %}
        var lon = "{{building.lon}}";
        var lat = "{{building.lat}}";
        var id = "{{building.pk}}";
        var type = "b";
        var name = "{{building}}";
    {% elif course %}
        var lon = "{{course.building.lon}}";
        var lat = "{{course.building.lat}}";
        var id = "{{course.pk}}";
        var type = "c";

        var name = "<div>{{course}} {{course.section}}</div>"+
                   "<div>"+truncate("{{course.title}}", 50)+"</div>"+
                   "<div>"+"{{course.building.names}}".split("/")[0]+" {{course.room}}</div>"+
                   "<div>{{course.day}} {{course.time}}</div>";
       if (!lon && !lat) {
          lon = -74.656509;
          lat = 40.346699;
        }
    {% endif %}
    {% if building or course %}
      var search = "<div>" + name + "</div>" +
          "<button id=\"addrow\" class=\"btn btn-success\" name=\"s\" onclick=\"save(\'"+id+type+"\')\" type=\"submit\">" +
              "<i class=\"fa fa-star\">"+"</i>"+"Favorite" +
          "</button>";
       L.marker([lat, parseFloat(lon)+offset]).addTo(searchLayer).bindPopup(search).openPopup();
       map.setView([lat, parseFloat(lon)+offset],17);
    {% endif %}
  </script>

</body>
</html>

{% endblock %}
